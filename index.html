<!DOCTYPE html>
<html>
<head>
  <title>Spin Wheel Shared State</title>
  <style>
    .spun { margin-bottom: 1em; }
    .pending { margin-bottom: 1em; font-style: italic; color: gray; }
    .color-box { display: inline-block; width: 20px; height: 20px; border: 1px solid #333; margin-right: 5px; }
  </style>
</head>
<body>
  <h1>Spin Wheel</h1>
  <div>
    <h2>Spun Results</h2>
    <div id="spun-list" class="spun"></div>
    <h2>Pending Names</h2>
    <div id="pending-list" class="pending"></div>
  </div>
  <div>
    <h3>Spin for...</h3>
    <select id="name-select"></select>
    <button id="spin-btn">Spin</button>
    <div id="spin-result"></div>
  </div>

<script>
const owner = 'imkhairulikhwan';
const repo = 'spin-wheel';
const resultsFile = 'spin-results.json';
// !! DO NOT USE THIS IN PRODUCTION !!
const githubToken = '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'; // Replace with your token for demo/testing

const allColors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'pink', 'brown', 'teal'];

async function fetchSpinResults() {
  const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${resultsFile}`);
  if (!res.ok) throw new Error('Could not fetch results file');
  const data = await res.json();
  const content = atob(data.content);
  return { ...JSON.parse(content), sha: data.sha };
}

function renderResults({ spun, pending }) {
  const spunDiv = document.getElementById('spun-list');
  spunDiv.innerHTML = spun.map(s => `<div><span class="color-box" style="background:${s.color}"></span> ${s.name}</div>`).join('');
  const pendingDiv = document.getElementById('pending-list');
  pendingDiv.innerHTML = pending.length ? pending.join(', ') : 'All have spun!';
  const select = document.getElementById('name-select');
  select.innerHTML = pending.map(name => `<option value="${name}">${name}</option>`).join('');
}

async function updateSpinResults(newResults, sha) {
  const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${resultsFile}`, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${githubToken}`,
      'Accept': 'application/vnd.github.v3+json'
    },
    body: JSON.stringify({
      message: 'Update spin results',
      content: btoa(JSON.stringify(newResults, null, 2)),
      sha
    })
  });
  if (!res.ok) throw new Error('Failed to update results');
  return await res.json();
}

async function spin() {
  document.getElementById('spin-btn').disabled = true;
  try {
    // Fetch current state
    const results = await fetchSpinResults();
    const { spun, pending, sha } = results;
    const name = document.getElementById('name-select').value;

    // Assign available color
    const usedColors = spun.map(s => s.color);
    const availableColors = allColors.filter(c => !usedColors.includes(c));
    const color = availableColors.length ? availableColors[0] : 'gray';

    // Update state
    const newSpun = [...spun, { name, color }];
    const newPending = pending.filter(n => n !== name);
    const newResults = { spun: newSpun, pending: newPending };

    // Update remote JSON
    await updateSpinResults(newResults, sha);
    renderResults(newResults);

    document.getElementById('spin-result').innerHTML = 
      `<b>${name}</b> spun and got color <span class="color-box" style="background:${color}"></span> ${color}`;
  } catch (e) {
    alert('Error: ' + e.message);
  }
  document.getElementById('spin-btn').disabled = false;
}

async function init() {
  try {
    const results = await fetchSpinResults();
    renderResults(results);

    document.getElementById('spin-btn').onclick = spin;
  } catch (e) {
    alert('Could not load results file. Please create spin-results.json in the repo with initial content.');
  }
}

init();
</script>
</body>
</html>
